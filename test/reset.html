<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password or Username</title>
</head>
<body>
    <h1>Reset Password or Username</h1>
    
    <!-- JavaScript code to retrieve URL parameters -->
    <script>
        // Function to get URL parameter by name
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }
        
        // Function to redirect to forgototp.html if phoneNumber is absent
        function redirectToForgotOtp() {
            window.location.href = 'forgototp.html';
        }
        
        // Function to redirect to forgot.html if option is empty
        function redirectToForgot() {
            window.location.href = 'forgot.html';
        }
        
        // Function to decode parameters using Base64
        function base64Decode(value) {
            return atob(value);
        }
    </script>

    <script>
        // Retrieve phone number and reset option from URL
        const encryptedPhoneNumber = getUrlParameter('phoneNumber');
        const encryptedOption = getUrlParameter('option');

        // Check if phoneNumber is absent and redirect to forgototp.html
        if (!encryptedPhoneNumber) {
            redirectToForgotOtp();
        }
        
        // Check if option is empty and redirect to forgot.html
        if (!encryptedOption) {
            redirectToForgot();
        }

        // Decrypt parameters
        const phoneNumber = base64Decode(encryptedPhoneNumber);
        const option = base64Decode(encryptedOption);

        // Display phone number
        document.write(`<p>Phone number: ${phoneNumber}</p>`);

        // Display appropriate form based on the reset option
        if (option === 'username') {
            document.write(`
                <form id="resetUsernameForm">
                    <label for="newUsername">New Username:</label>
                    <input type="text" id="newUsername" name="newUsername" required>
                    <br>
                    <label for="confirmUsername">Confirm Username:</label>
                    <input type="text" id="confirmUsername" name="confirmUsername" required>
                    <br>
                    <button type="button" onclick="resetUsername()">Reset Username</button>
                </form>
            `);
        } else if (option === 'password') {
            document.write(`
                <form id="resetPasswordForm">
                    <label for="newPassword">New Password:</label>
                    <input type="password" id="newPassword" name="newPassword" required>
                    <br>
                    <label for="confirmPassword">Confirm Password:</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required>
                    <br>
                    <button type="button" onclick="resetPassword()">Reset Password</button>
                </form>
            `);
        } else {
            document.write(`<p>Invalid reset option: ${option}</p>`);
        }

        // Function to reset username
        async function resetUsername() {
            const newUsername = document.getElementById('newUsername').value;
            const confirmUsername = document.getElementById('confirmUsername').value;

            if (newUsername !== confirmUsername) {
                alert('New username and confirmed username do not match');
                return;
            }
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`https://learning-u7aw.onrender.com/api/users/${phoneNumber}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ option, newData: newUsername })
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(data.message);
                } else if (response.status === 400) {
                    const errorData = await response.json();
                    alert(errorData.error);
                } else {
                    alert('Failed to reset username. Please try again.');
                }
            } catch (error) {
                console.error('Error resetting username:', error);
                alert('Failed to reset username. Please try again.');
            }
        }

        // Function to reset password
        async function resetPassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('New password and confirmed password do not match');
                return;
            }
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`https://learning-u7aw.onrender.com/api/users/${phoneNumber}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ option, newData: newPassword })
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(data.message);
                    // Redirect to login page after successful password reset
                    window.location.href = 'login.html';
                } else if (response.status === 400) {
                    const errorData = await response.json();
                    alert(errorData.error);
                } else {
                    alert('Failed to reset password. Please try again.');
                }
            } catch (error) {
                console.error('Error resetting password:', error);
                alert('Failed to reset password. Please try again.');
            }
        }
    </script>
</body>
</html>
